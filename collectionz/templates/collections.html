{% extends "base.html" %}

{% load crispy_forms_tags %}

{% block head %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}

{% block title %}TasteTribe - Raccolte{% endblock %}

{% block content %}

<h1>TasteTribe - Raccolte di ricette</h1>
<h2>Benvenuto nella sezione raccolte!</h2>
<div class="my-collections">
    <h2>Le tue raccolte:</h2>
    {% if user_collections %}
    <ul class="my-collections-list">
        {% for user_collection in user_collections %}
        	<li>
                <a href="{% url 'collection_details' user_collection.collection_guid %}">
                    <h3>{{ user_collection.collection_name }}</h3> <img src="data:image/jpeg;base64,{{ user_collection.collection_cover }}" alt="">
                    <small>di {{ user_collection.collection_author.first_name }} {{ user_collection.collection_author.last_name }} - creata in data {{ user_collection.collection_creation_date }}</small>
                </a>
            </li>
        {% endfor %}
    </ul>
    <button id="btnCollectionCreation" data-bs-toggle="modal" data-bs-target="#collectionCreationModal">Crea una nuova raccolta</button>
    {% else %}
    <p>Sembra che tu non abbia ancora creato delle raccolte, <button id="btnCollectionCreation" data-bs-toggle="modal" data-bs-target="#collectionCreationModal">creane subito una!</button></p>
    {% endif %}
</div>
<div class="recommended-collections">
    <h2>Raccolte per te</h2>
    {% if other_collections %}
    <ul class="recommended-collections-list">
            {% for collection in other_collections %}
                {% if not collection.collection_is_private %}
                <li>
                    <a href="{% url 'collection_details' collection.collection_guid %}">
                        <h3>{{ collection.collection_name }}</h3> <img src="data:image/png;base64,{{ collection.collection_cover }}" alt="">
                        <small>di {{ collection.collection_author.first_name }} {{ collection.collection_author.last_name }} - creata in data {{ collection.collection_creation_date }}</small>
                    </a>
                </li>
                {% endif %}
            {% endfor %}
    </ul>
    {% else %}
    <p>Spiacente, al momento non ci sono nuove raccolte di ricette da scoprire!</p>
    {% endif %}
</div>

<!-- Modal for Collection Creation -->
<div class="modal fade" id="collectionCreationModal" tabindex="-1" aria-labelledby="collectionCreationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="collectionCreationModalLabel">Crea una nuova raccolta di ricette</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="collectionCreationForm" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    {% crispy form %}
                    <input type="hidden" id="b64_collection_cover" name="collection_cover">
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        $("#collectionCreationForm").on("submit", function(event) {
            event.preventDefault();

            var collectionCover = document.getElementById("id_collection_cover");
            var file = collectionCover.files[0];

            if (file) {
                var reader = new FileReader();
                reader.onloadend = function() {
                    var base64String = reader.result;
                    $("#b64_collection_cover").val(base64String);
                    submitForm();
                };
                reader.readAsDataURL(file);
            } else {
                submitForm();
            }
        });

        function submitForm() {
            $.ajax({
                url: "{% url 'collections' %}",
                type: "POST",
                data: new FormData($("#collectionCreationForm")[0]),
                processData: false,
                contentType: false,
                success: function(response) {
                    $("#collectionCreationModal").modal("hide");
                    location.reload();
                },
                error: function(xhr, status, error) {
                    console.error(xhr.responseText);
                    alert("Spiacente, si Ã¨ verificato un errore in fase di creazione, riprovare!");
                }
            });
        }
    });
</script>

{% endblock %}