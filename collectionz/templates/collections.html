{% extends "base.html" %}

{% load crispy_forms_tags %}

{% block head %}

{% load static %}

{% endblock %}

{% block title %}TasteTribe - Raccolte{% endblock %}

{% block content %}

<h1>TasteTribe - Raccolte di ricette</h1>
<h2>Benvenuto nella sezione raccolte!</h2>

<!-- Section that will display collections created by the user -->
<div class="my-collections">
    <h2>Le tue raccolte:</h2>
    {% if user_collections %}
    <ul class="my-collections-list">
        {% for collection in user_collections %}
            {% include "collection_list_item.html" %}
        {% endfor %}
    </ul>
    <button id="btnCollectionCreation" data-bs-toggle="modal" data-bs-target="#collectionCreationModal">Crea una nuova raccolta</button>
    {% else %}
    <p>Sembra che tu non abbia ancora creato delle raccolte, <button id="btnCollectionCreation" data-bs-toggle="modal" data-bs-target="#collectionCreationModal">creane subito una!</button></p>
    {% endif %}
</div>
<!-- Section that will display a list of up to 5 recommended collections -->
<div class="recommended-collections">
    <h2>Raccolte per te:</h2>
    {% if recommended_collections %}
    <ul class="recommended-collections-list">
            {% for collection in recommended_collections %}
                {% if not collection.collection_is_private %}
                    {% include "collection_list_item.html" %}
                {% endif %}
            {% endfor %}
    </ul>
    {% else %}
    <p>Spiacente, sulla base dei dati forniti non riusciamo a produrre dei suggerimenti pertinenti!</p>
    {% endif %}
</div>
<!-- Section that will display all the other collections that the user can see -->
<div class="other-collections">
    <h2>Altre raccolte:</h2>
    {% if other_collections %}
    <ul class="other-collections-list">
            {% for collection in other_collections %}
                {% if not collection.collection_is_private %}
                    {% include "collection_list_item.html" %}
                {% endif %}
            {% endfor %}
    </ul>
    {% else %}
    <p>Spiacente, al momento non ci sono nuove raccolte di ricette da scoprire!</p>
    {% endif %}
</div>

{% include "collection_creation_modal.html" %}

<script>
    $(document).ready(function() {
        $("#collectionCreationForm").on("submit", function(event) {
            event.preventDefault();

            var collectionCover = document.getElementById("id_collection_cover");
            var file = collectionCover.files[0];

            if (file) {
                var reader = new FileReader();
                reader.onloadend = function() {
                    var base64String = reader.result;
                    $("#b64_collection_cover").val(base64String);
                    submitForm();
                };
                reader.readAsDataURL(file);
            } else {
                submitForm();
            }
        });

        function submitForm() {
            $.ajax({
                url: "{% url 'collections' %}",
                type: "POST",
                data: new FormData($("#collectionCreationForm")[0]),
                processData: false,
                contentType: false,
                success: function(response) {
                    $("#collectionCreationModal").modal("hide");
                    location.reload();
                },
                error: function(xhr, status, error) {
                    console.error(xhr.responseText);
                    alert("Spiacente, si Ã¨ verificato un errore in fase di creazione, riprovare!");
                }
            });
        }
    });
</script>

{% endblock %}