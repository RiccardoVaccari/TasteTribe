{% extends "base.html" %}

{% load custom_tags %}

{% block head %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

{% endblock %}

{%  block title %} {{ recipe.recipe_name }} {% endblock %}

{% block content %}

<h1>{{ recipe.recipe_name }}</h1>

{% if owner %}

<a href="{% url 'recipe_edit' recipe.recipe_guid %}" class="btn btn-primary">
    Modifica ricetta
</a>

<button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
    Elimina ricetta
</button>

{% endif %}

<a href="{% url 'recipe_create_from_existing' recipe.recipe_guid %}" class="btn btn-secondary">
    Crea nuova ricetta a partire da questa
</a>

<p><strong>Preparation Time:</strong> {{ recipe.recipe_prep_time }}</p>
<p><strong>Cover:</strong> <img src="data:image/png;base64,{{ recipe.recipe_cover }}"> </p>
<p><strong>Notes:</strong> {{ recipe.recipe_notes }}</p>
<p><strong>Description:</strong> {{ recipe.recipe_description }}</p>
<p><strong>Category:</strong> {{ recipe.recipe_category }}</p>
<p><strong>Private:</strong> {{ recipe.recipe_is_private }}</p>
<p><strong>Vegetarian:</strong> {{ recipe.recipe_is_vegetarian }}</p>
<p><strong>Gluten Free:</strong> {{ recipe.recipe_gluten_free }}</p>
<p><strong>Vegan:</strong> {{ recipe.recipe_is_vegan }}</p>
<p><strong>Creation Date:</strong> {{ recipe.recipe_creation_date }}</p>
<p><strong>Author:</strong> {{ recipe.recipe_author.first_name }} {{ recipe.recipe_author.last_name }}</p>

{% render_recipe_related_tags recipe.recipe_guid %}

{% render_recipe_ingredients recipe.recipe_guid %}

{% render_recipe_steps recipe.recipe_guid %}

{% render_recipe_related_recipes related_recipes %}

{% render_recipe_reviews request.user recipe.recipe_guid %}

<!-- Modal for confirming deletion -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Conferma eliminazione</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Sei sicuro di voler eliminare questa ricetta? Questa azione non può essere annullata.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Elimina</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Handle delete confirmation
        $('#confirmDelete').click(function() {
            $.ajax({
                url: "{% url 'delete_recipe' recipe.recipe_guid %}",
                type: "POST",
                data: {
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                success: function(response) {
                    window.location.href = "/";  // Redirect to homepage on success
                },
                error: function(xhr) {
                    alert("Si è verificato un errore durante l'eliminazione della ricetta.");
                }
            });
        });

        // Handling like and dislike interactions (existing functionality)
        $(document).on("click", ".like-icon, .dislike-icon", function() {
            const reviewId = $(this).data("review-id");
            const interactionType = $(this).data("interaction-type");

            {% if request.user.is_authenticated %}
            $.ajax({
                url: "{% url 'review_interaction' %}",
                method: "POST",
                data: {
                    "review_id": reviewId,
                    "interaction_type": interactionType,
                    "csrfmiddlewaretoken": "{{ csrf_token }}"
                },
                success: function(data) {
                    const reviewElement = $("#review-" + data.review_id);
                    const likeIcon = $("#like-icon-" + data.review_id);
                    const dislikeIcon = $("#dislike-icon-" + data.review_id);

                    reviewElement.find(".like-icon small").text(data.likes);
                    reviewElement.find(".dislike-icon small").text(data.dislikes);

                    if (data.user_rev_interaction === 1) {
                        likeIcon.removeClass();
                        likeIcon.addClass("fa-solid fa-thumbs-up");
                        likeIcon.css("color", "#0a9900");
                        dislikeIcon.removeClass();
                        dislikeIcon.addClass("fa-regular fa-thumbs-down");
                        dislikeIcon.css("color", "#000000");
                    } else if (data.user_rev_interaction === -1) {
                        likeIcon.removeClass();
                        likeIcon.addClass("fa-regular fa-thumbs-up");
                        likeIcon.css("color", "#000000");
                        dislikeIcon.removeClass();
                        dislikeIcon.addClass("fa-solid fa-thumbs-down");
                        dislikeIcon.css("color", "#b80000");
                    } else {
                        likeIcon.removeClass();
                        likeIcon.addClass("fa-regular fa-thumbs-up");
                        likeIcon.css("color", "#000000");
                        dislikeIcon.removeClass();
                        dislikeIcon.addClass("fa-regular fa-thumbs-down");
                        dislikeIcon.css("color", "#000000");
                    }
                }
            });
            {% else %}
            alert("ATTENZIONE: Devi essere registrato per poter mettere mi piace alle recensioni!");
            {% endif %}
        });
    });
</script>

{% endblock %}